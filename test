<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Employee Equipment Inventory</title>

  <!-- SheetJS (standalone browser script) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body{font-family:Inter,Arial,sans-serif;background:#f4f6f8;display:flex;justify-content:center;padding:30px}
    .card{width:880px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 22px rgba(15,23,42,0.08)}
    h1{margin:0 0 12px 0;font-size:18px}
    .controls{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    .btn{background:#0b69ff;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .btn.secondary{background:#e6eefc;color:#0b69ff}
    .employees{margin-top:8px;max-height:540px;overflow:auto;padding-right:6px}
    .employee{border:1px solid #e6e9ef;border-radius:8px;padding:10px;margin-bottom:10px;background:#fff}
    .employee-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .employee-name{font-weight:600}
    .employee-details{margin-top:10px;display:none}
    .equip-list{margin-top:10px}
    .equip-item{border:1px solid #eef2f7;border-radius:8px;padding:8px;margin-bottom:8px;background:#fbfdff}
    .equip-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    label{display:block;font-size:13px;margin-top:8px}
    input[type=text], select, input[type=date]{width:100%;padding:8px;border:1px solid #d6dbe8;border-radius:6px;margin-top:6px}
    .small{font-size:13px;color:#55617a}
    .icon{width:16px;height:16px;display:inline-block}
  </style>
</head>
<body>
  <div class="card">
    <h1>Employee Equipment Inventory</h1>

    <div class="controls">
      <button class="btn" id="downloadBtn" title="Download Excel">
        <!-- small download SVG icon -->
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download Excel
      </button>

      <button class="btn secondary" id="addEmployeeBtn" title="Add employee">+ Add Employee</button>

      <div style="margin-left:auto" class="small">Tip: collapsed cards show device + last 3 chars of SN</div>
    </div>

    <div class="employees" id="employeesContainer"></div>
  </div>

<script>
/* Simple model to track employees/equipment */
const employees = [];

/* Helpers */
function createElem(html) {
  const d = document.createElement('div');
  d.innerHTML = html;
  return d.firstElementChild;
}

/* Add employee */
document.getElementById('addEmployeeBtn').addEventListener('click', () => {
  const id = Date.now() + Math.floor(Math.random()*1000);
  employees.push({ id, name: '', equipments: [], expanded: false });
  renderEmployees();
});

/* Render employees list */
function renderEmployees() {
  const container = document.getElementById('employeesContainer');
  container.innerHTML = '';
  employees.forEach((emp, empIndex) => {
    const empEl = createElem(`
      <div class="employee" data-emp-index="${empIndex}">
        <div class="employee-header">
          <div>
            <div class="employee-name" id="label_emp_${emp.id}">${emp.name || 'New Employee'}</div>
            <div class="small">Click to expand / edit</div>
          </div>
          <button class="btn secondary" data-action="toggle-emp">▶</button>
        </div>
        <div class="employee-details" id="details_emp_${emp.id}">
          <label>Employee Name</label>
          <input type="text" id="input_emp_name_${emp.id}" placeholder="e.g. YOUSSEF RAHMOUNI" value="${emp.name || ''}" />
          <div class="equip-list" id="equip_list_${emp.id}"></div>
          <div style="margin-top:8px">
            <button class="btn" data-action="add-equip">+ Add Equipment</button>
          </div>
        </div>
      </div>
    `);

    /* append and wire events */
    container.appendChild(empEl);

    empEl.querySelector('[data-action="toggle-emp"]').addEventListener('click', () => {
      // collapse all other employees
      document.querySelectorAll('.employee-details').forEach((d, i) => {
        if (i !== empIndex) d.style.display = 'none';
      });
      const det = document.getElementById(`details_emp_${emp.id}`);
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    });

    const nameInput = document.getElementById(`input_emp_name_${emp.id}`);
    nameInput.addEventListener('input', (e) => {
      emp.name = e.target.value;
      document.getElementById(`label_emp_${emp.id}`).innerText = emp.name || 'New Employee';
    });

    empEl.querySelector('[data-action="add-equip"]').addEventListener('click', () => {
      addEquipment(emp.id);
    });

    renderEquipList(emp.id);
  });
}

/* Add equipment to a given employee id */
function addEquipment(empId) {
  const emp = employees.find(e => e.id === empId);
  if (!emp) return;
  const eqId = Date.now() + Math.floor(Math.random()*1000);
  emp.equipments.push({ id: eqId, type: 'PC', serial: '', date: '' });
  renderEquipList(empId);
}

/* Render equipment list for employee */
function renderEquipList(empId) {
  const emp = employees.find(e => e.id === empId);
  const list = document.getElementById(`equip_list_${empId}`);
  if (!list) return;
  list.innerHTML = '';
  emp.equipments.forEach((eq, eqIndex) => {
    const shortSN = (eq.serial || '').slice(-3);
    const eqEl = createElem(`
      <div class="equip-item" data-eq-index="${eqIndex}">
        <div class="equip-header">
          <div id="label_eq_${eq.id}">${eq.type} - ${shortSN || '---'}</div>
          <button class="btn secondary" data-action="toggle-eq">▶</button>
        </div>
        <div class="equip-details" id="details_eq_${eq.id}">
          <label>Equipment Type</label>
          <select id="select_eq_type_${eq.id}">
            <option>PC</option>
            <option>ECRAN</option>
            <option>CLAVIER SOURIS</option>
            <option>CASQUE</option>
            <option>PHONE</option>
            <option>FIX</option>
            <option>SIM</option>
          </select>

          <label>Received Date</label>
          <input type="date" id="input_eq_date_${eq.id}" />

          <label>Serial Number</label>
          <input type="text" id="input_eq_serial_${eq.id}" placeholder="e.g. WUU9223S" />

        </div>
      </div>
    `);

    list.appendChild(eqEl);

    // toggle equipment details: ensure only one opened per employee
    eqEl.querySelector('[data-action="toggle-eq"]').addEventListener('click', () => {
      const details = document.querySelectorAll(`#equip_list_${empId} .equip-details`);
      details.forEach((d, i) => {
        if (i !== eqIndex) d.style.display = 'none';
      });
      const det = document.getElementById(`details_eq_${eq.id}`);
      det.style.display = det.style.display === 'block' ? 'none' : 'block';
    });

    // input handlers - update model and collapsed label
    const selType = document.getElementById(`select_eq_type_${eq.id}`);
    const inpDate = document.getElementById(`input_eq_date_${eq.id}`);
    const inpSerial = document.getElementById(`input_eq_serial_${eq.id}`);

    selType.value = eq.type;
    inpDate.value = eq.date;
    inpSerial.value = eq.serial;

    function refreshLabel() {
      const short = (eq.serial || '').slice(-3);
      document.getElementById(`label_eq_${eq.id}`).innerText = `${eq.type} - ${short || '---'}`;
    }

    selType.addEventListener('change', (e) => { eq.type = e.target.value; refreshLabel(); });
    inpDate.addEventListener('change', (e) => { eq.date = e.target.value; });
    inpSerial.addEventListener('input', (e) => { eq.serial = e.target.value; refreshLabel(); });
  });
}

/* Build rows and export to Excel via SheetJS */
document.getElementById('downloadBtn').addEventListener('click', () => {
  const rows = [];
  employees.forEach(emp => {
    emp.equipments.forEach(eq => {
      // only export filled lines
      if ((emp.name || '').trim() && (eq.type || '').trim() && (eq.serial || '').trim() && (eq.date || '').trim()) {
        rows.push({
          Employee: emp.name.trim(),
          Equipment: eq.type.trim(),
          Received_Date: eq.date,
          Serial_Number: eq.serial.trim()
        });
      }
    });
  });

  if (rows.length === 0) {
    alert('No complete entries to export. Please fill employee name and equipment fields.');
    return;
  }

  // Use SheetJS to create and save workbook
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Inventory');

  /* write and trigger download */
  XLSX.writeFile(wb, 'Employee_Inventory.xlsx');
});

/* Initial small demo row so user sees structure (optional) */
(function seedDemo(){
  document.getElementById('addEmployeeBtn').click();
  const emp = employees[0];
  emp.name = 'YOUSSEF RAHMOUNI';
  renderEmployees();
  addEquipment(emp.id);
  // set demo values (not required)
  const firstEq = emp.equipments[0];
  firstEq.type = 'PC';
  firstEq.serial = 'WUU9223S';
  firstEq.date = new Date().toISOString().slice(0,10);
  renderEquipList(emp.id);
})();
</script>
</body>
</html>